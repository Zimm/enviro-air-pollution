<html>
<head>
    <title>Air Pollution around LUC</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <script type="text/javascript" src="databank.js"></script>
    <script type="text/javascript">
    var markersArray = [];
    var map;
    var default_latlng = new google.maps.LatLng(42.0018550, -87.65818399999999);
    var infowindow;
    var lookedUpAddr = {};


    function get_latlng_addr(address, async, callback, param) {
        if (lookedUpAddr[address]) {
            return lookedUpAddr[address];
        }
        var xmlhttp = new XMLHttpRequest();
        if (async) {
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    // console.log("rec " + xmlhttp.responseText);
                    var responseobj = JSON.parse(xmlhttp.response);
                    if (responseobj["status"] === "OK") {
                        var result = responseobj["results"][0];
                        var retgeo = result["geometry"];
                        var retloc = retgeo["location"];
                        var lat = retloc["lat"];
                        var lng = retloc["lng"];
                        var result = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
                        lookedUpAddr[address] = result;
                        callback(result, param);
                    } else {
                        callback(null, param);
                    }
                }
            };
        }
        xmlhttp.open("GET", "http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(address) + "&sensor=false", async);
        xmlhttp.send();
        if (!async) {
            if (xmlhttp.status == 200) {
                var responseobj = JSON.parse(xmlhttp.response);
                if (responseobj["status"] === "OK") {
                    var result = responseobj["results"][0];
                    var retgeo = result["geometry"];
                    var retloc = retgeo["location"];
                    var lat = retloc["lat"];
                    var lng = retloc["lng"];
                    var result = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
                    lookedUpAddr[address] = result;
                    return result;
                }
            }
            lookedUpAddr[address] = default_latlng;
            return default_latlng; //default
        }
    }

    function initialize() {
        // version 1.1
        var mapOptions = {
            center: default_latlng,
            zoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        var loyola_latlng = get_latlng_addr("Loyola University Chicago Lake Shore Campus, North Sheridan Road, Chicago, IL");
        map.setCenter(loyola_latlng, false, null);
        var amarker = addMarker(loyola_latlng, "Loyola University Chicago Lake Shore Campus");
        infowindow = new google.maps.InfoWindow();
        google.maps.event.addListener(amarker, 'click', moveInfoWindow);
        infowindow.setContent(amarker.getTitle()); //need to add specific info about type of pollutant, also style this, eek
        infowindow.setPosition(amarker.getPosition());
        infowindow.open(map);
    }
    google.maps.event.addDomListener(window, 'load', initialize);

    window.onload = function() {
        var i;
        for(i=0;i<sources.length;i++) {
            var asource = sources[i];
            // setTimeout(function() {
            get_latlng_addr(asource.address, true, function(res, tsource) {
                var amarker = addMarker(res, tsource.company);
                amarker.associatedSource = tsource;
                google.maps.event.addListener(amarker, 'click', moveInfoWindow);
            }, asource);
            // }, (i + 1)*200);
        }
    };

    function moveInfoWindow(event) {
        infowindow.setContent(this.getTitle()); //need to add specific info about type of pollutant, also style this, eek
        infowindow.setPosition(event.latLng);
        infowindow.open(map);
    }

    function addMarker(location, titl) {
        marker = new google.maps.Marker({
            position: location,
            map: map,
            title: titl
        });
        markersArray.push(marker);
        return marker;
    }

    function clearOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
        }
    }

    function showOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(map);
            }
        }
    }

    function deleteOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
            markersArray.length = 0;
        }
    }


    </script>
</head>
<body>
    <div id="map-canvas"/>
</body>
</html>