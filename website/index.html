<html>
<head>
    <title>Air Pollution around LUC</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <script type="text/javascript" src="databank.js"></script>
    <script type="text/javascript">
    var markersArray = [];
    var map;
    var default_latlng = new google.maps.LatLng(42.0018550, -87.65818399999999);
    var infowindow;
    var lookedUpAddr = {};
    var geocoder = new google.maps.Geocoder();


    function get_latlng_addr(addr, callback, param) {
        if (lookedUpAddr[addr]) {
            return lookedUpAddr[addr];
        }
        /*
        geocoder.geocode( { address : addr }, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                lookedUpAddr[addr] = results[0].geometry.location;
                callback(results[0].geometry.location, param);
            } else {
                console.log("Failed because " + status);
                callback(null, param);
            }
        });
        return;*/
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                // console.log("rec " + xmlhttp.responseText);
                var responseobj = JSON.parse(xmlhttp.response);
                // console.log("I got " + responseobj);
                if (responseobj["status"] === "OK") {
                    var result = responseobj["results"][0];
                    var retgeo = result["geometry"];
                    var retloc = retgeo["location"];
                    var lat = retloc["lat"];
                    var lng = retloc["lng"];
                    console.log("Found pos " + lat + " , " + lng);
                    var result = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
                    lookedUpAddr[addr] = result;
                    callback(result, param);
                } else {
                    // console.log("erm " + xmlhttp.responseText);
                    callback(null, param);
                }
            }
        };
        xmlhttp.open("GET", "http://www.datasciencetoolkit.org/maps/api/geocode/json?address=" + encodeURIComponent(addr) + "&sensor=false", false);
        xmlhttp.send();
    }

    function initialize() {
        // version 1.1
        var mapOptions = {
            center: default_latlng,
            zoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        get_latlng_addr("Loyola University Chicago Lake Shore Campus, North Sheridan Road, Chicago, IL", 
            function(loyola_latlng, param) {
                map.setCenter(loyola_latlng);
                var amarker = addMarker(loyola_latlng, "Loyola University Chicago Lake Shore Campus");
                infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(amarker, 'click', moveInfoWindow);
                infowindow.setContent(amarker.getTitle()); //need to add specific info about type of pollutant, also style this, eek
                infowindow.setPosition(amarker.getPosition());
                infowindow.open(map);
            }, null);
    }
    google.maps.event.addDomListener(window, 'load', initialize);

    window.onload = function() {
        var i;
        var locs = [];
        for(i=0;i<sources.length;i++) {
            var as = sources[i];
            var geostuff = as.geocodedAddress;
            if (geostuff["status"] === "OK") {
                var result = geostuff["results"][0];
                var retgeo = result["geometry"];
                var retloc = retgeo["location"];
                var lat = retloc["lat"];
                var lng = retloc["lng"];
                // console.log("Found pos " + lat + " , " + lng);
                setTimeout(function(lt, lg, asource) {
                    var result = new google.maps.LatLng(parseFloat(lt), parseFloat(lg));
                    var amarker = addMarker(result, asource.company, { path: google.maps.SymbolPath.CIRCLE, scale: 3, fillColor: "black", fillOpacity: 0.8, strokeWeight: 2, strokeColor: "red" } );
                    amarker.associatedSource = asource;
                    google.maps.event.addListener(amarker, 'click', moveInfoWindow);
                }, 2*i, lat, lng, as);
            } else {
                console.log("No geocoded data? " + as.company);
            }
        }
    };

    function moveInfoWindow(event) {
        infowindow.setContent(this.getTitle()); //need to add specific info about type of pollutant, also style this, eek
        infowindow.setPosition(event.latLng);
        infowindow.open(map);
    }

    function addMarker(location, titl, ico) {
        marker = new google.maps.Marker({
            position: location,
            map: map,
            title: titl,
            icon: ico
        });
        markersArray.push(marker);
        return marker;
    }

    function clearOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
        }
    }

    function showOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(map);
            }
        }
    }

    function deleteOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
            markersArray.length = 0;
        }
    }


    </script>
</head>
<body>
    <div id="map-canvas"/>
</body>
</html>